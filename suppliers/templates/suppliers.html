 {%extends 'base.html'%} {%block head%} {{super()}}
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.2.4.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" /> {%endblock%} 


<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" />



{%block content%}


<div id="successAlert" class="alert alert-success" role="alert" style="display:none;"></div>
<div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;"></div>
<div class>
    <script src="{{url_for('.static', filename='supp.js')}}"></script>
    <script src="{{url_for('.static', filename='add.js')}}"></script>

    

        <div id="successAlert" class="alert alert-success" role="alert" style="display:none;">

        </div>
        <div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;">


        </div> 

        <div id='new_transit'>
            <form id='write_transit' action="" method="POST">
                
                <p style="margin:10px">{{formTransit.innadd(placeholder='указать ИНН')}}
                <input type="submit" id='write_transit'></p>
            </form>

            

        <script>
        
        $("form#write_transit").bind('click', function(e){
            console.log('ready')
            e.preventDefault()
           
            $.getJSON('/suppliers/add_third_party',{
                inn:$('input#innadd').val(),
                type:'POST',
                data:'/suppliers/add_third_party',
                
            }, function(data){
                console.log(data)
                if(data.error){
                    $('#errorAlert').text(data.error).show();
                    $('#successAlert').hide();
                }else{
                    window.setTimeout(function() { location.reload() }, 3000);
                    $('#successAlert').text(data.success).show()
                    $('#errorAlert').hide();
                }
            })

        })
            

        </script>



        </div>
</div>
        {%if supp%}

        <div id="content"> 

        
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Долг Итого</th>
                            <th>Дата последнего платежа</th>
                        </tr>
                    </thead>
                    <tbody>
                        <th>
                            {{supp.total_credit()}} РУБ
                        </th>
                        
                      
                        <th>
                            {{supp.last_payment()}}

                        </th>
                        
                        
                        </tbody>
                    </tbody>
        
        
                </table>
               
        </div>
        {%endif%}
        

        <table class="table table-sm">
        <thead>
            <tr>
                <th>Поиск по имени</th>
                <th>Поиск по ИНН</th>
                
            </tr>
        </thead>
        <tbody>
            <th>
                    <form action=""  method="POST">
                            {{ formName.csrf_token }}
                            
                            {{formName.name.label()}}{{formName.name}}
                            <input type="submit">
                    </form>
            
            </th>
            <th>
                    <form action=""  method="POST">
                            {{ formINN.csrf_token }}
                            {{formINN.check_inn.label()}}  {{formINN.check_inn}}
                            <input type="submit">
                    </form>

            </th>
        </tbody>
        </table>
       
        

        <div id='content'>

           

        <table class="table table-sm">
            
             <thead>
               
                <tr>
            
                        
                <th style="display:none;">Id перевоза</th>
                
                
                <th>Номер счета</th>
                <th>Дата счета</th>
                <th>Сумма счета</th>
                <th>Номер перевозки</th>
                <th>На кого выставлен</th>
                
                <th>Ссылки на счет</th>
                <th>Остаемся должны</th>
                <th>Дата последнего платежа</th>
                <th>Количество платежей по счету</th>


              
          
    
            </tr>

            <tbody>
                {%for inv in invoices%}
                <tr>
                  
                    <th id='id'  style="display:none;">{{inv.supplier_id}}</th>
                    
                   
                    <th>{{inv.s_inv_number}}</th>
                    <th>{{inv.s_invoice_date.strftime('%Y-%m-%d')}}</th>
                    <th>{{inv.s_inv_amount}}</th>
                    <th>{{inv.fin_id}}</th>
                    <th>{{inv.tora_red}}</th>
                    <th>
                        {%for path in inv.invoice()%}
                        <p><a href="{{url_for('supp.download_s_inv', filename=path)}}">{{path}}</a></p>
                        {%endfor%}
                         
                    </th>
                    <th>{{inv.still_own()}}</th>
                    
                    
                    <th>{{inv.last_payment()}}</th>
                   
                   
                    
                    <th>{{inv.count_payments()}}</th>
                    
                    
                    
                   
           
                {%endfor%}


                <!-- <th id='id'>{{supp.id}}</th>
                <th>{{supp.llc_name}}</th>
                <th>{{supp.inn}}</th> -->
                <!-- <th>{%for i in supp.prefin%}<p>{{i.id}}</p>{%endfor%}</th> -->
                <!-- {%if supp%}
                <th>{{supp.prefin|length}}</th>
                <th>
                    {%for inv in supp.prefin%}

                        {%for invoice in supp.inv %}
                            {%if inv.invs.all()|length > 0%}
                          
                            <p><a href="{{url_for('supp.download_s_inv', filename=invoice.path)}}">{{invoice.path}}</a></p>
                            {%else%}
                            <p>None</p>
                            {%endif%}
                            
                    
                        {%endfor%}
                    {%endfor%}

                </th>
            <th>
                {%for inv in supp.prefin%}
                <p>{{inv.tora_red}}</p>
                {%endfor%}
            </th>
                <th>
                    {%for inv in supp.invoices_list()%}
                    
                 <p>{{inv}}     </p>           
                     {%endfor%}
                    
                </th>

                <th>
                    {%for inv in supp.invoice_amount_list()%}
                    <p>{{inv}}</p>
                    {%endfor%}
                </th>
                <th>
                    {%for inv in supp.supp_payment%}
                        <p>{{inv.still_own()}}</p>
                        {%endfor%}
                </th>




                {%endif%} -->

            </tbody>
            
      {%if supp%}

 
<div id="content1">
    <table class="table table-sm">

            

        <thead>
            <tr>
                
                <th>Действие</th>
                <th>номера счета</th>
                <th>сумма оплаты</th>
                <th>через кого платим(Транзит)</th>
                <th>Коммисия</th>
                <th>дата платежа</th>
            </tr>
        </thead>

       
        <tbody>
            
            
            <th>
               <button id="write">Записать</button>
            </th>
            
            <form id='one' action="">
            <th bgcolor ='#A5B3BA' name='inv_number' id='number'>{{formInv.supp_all_invoices}}</th>
            <th bgcolor="#A5BAAF">{{formInv.summ_pay}}</th>
            <th bgcolor="#A7AEC9">{{formInv.transit}}</th>
            <th bgcolor='#B16F61'>{{formInv.commision}}</th>
            <th bgcolor="#D4EFDF ">{{formInv.date_payment}}</th>
            </form>
          
        </tbody>
    

        

    </table> 
</div>
    {%endif%}
            
    
    </div>
    <div id="successAlert" class="alert alert-success" role="alert" style="display:none;"></div>
    <div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;"></div>
    <script>
      

        $('#write').bind('click', function(e) {
        
        e.preventDefault();

        $.getJSON('/suppliers/suppliers_payments_to_db',{
            supplier:$('#id').text(),
            summ_amount:$('#summ_pay').val(),
            supp_payment_id:$("#supp_all_invoices").val(),
            transit:$("#transit").val(),
            commision:$("#commision").val(),
            day:$("#date_payment").val(),
            type:'POST',
            data: '/suppliers/suppliers_payments_to_db',
        }, function(data){
            console.log(data.error)
            
            if(data.error){
                $('#errorAlert').text(data.error).show();
                $('#successAlert').hide();
            }else{
                $('#errorAlert').hide();
                $('#successAlert').text(data.success).show();
                window.setTimeout(function() { location.reload() }, 1000)
                
            }
            
           
            
        }
        
        )
        });
   
    </script>
    <p></p>
    <p></p>
    <p></p>
    <p></p>

    <div id='r' onclick="myFunction(event)">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>№ Счета</th>
                    <th>Сумма оплат</th>
                    <th>Дата оплаты</th>
                    <th>Через кого платим</th>
                    
                        <th>Удалить</th>
                        
                </tr>
            </thead>
            <tbody>
                {%for inv in  invoices%}
                <tr>
                   
                    <th>
                             
                                {{inv.s_inv_number}}
                            
                        </th>
                    
                        <th>
                            {%for invs in invoice_payments%}
                            {%if invs.supp_payment == inv.id%}
                            <p>{{invs.summ_pay}}</p>
                            {%endif%}
                            {%endfor%}
                            
                        </th>

                        <th>
                            {%for invs in invoice_payments%}
                                {%if invs.supp_payment == inv.id%}
                                <p>{{invs.date_payment.strftime('%Y-%m-%d')}}</p>
                                {%endif%}
                                {%endfor%}
                            </th>

                            <th>
                                    {%for invs in invoice_payments%}
                                        {%if invs.supp_payment == inv.id%}
                                        <p>{{invs.transit.inn}}</p>
                                        {%endif%}
                                        {%endfor%}
                                    </th>
                                
                                    <th>
                                            {%for invs in invoice_payments%}
                                                {%if invs.supp_payment == inv.id%}
                                             
                                                <p id='id'>
                                                   
                                                        <button  id='remove_payment' style="color:red"
                                                        class="glyphicon glyphicon-remove-circle">{{invs.id}}</button></p>    
                                                
                                                
                                                </p>

                                            
                                                {%endif%}
                                            
                                                {%endfor%}
                                            </th>  
                                         
                         </div>

                </tr>
                {%endfor%}
            </tbody>
        </table>
    
        
 
        
            

    </div>

    <script>
         let del_button = document.getElementById("remove_payment")
            function myFunction(event ) {
                console.log(event.target.id)
              
                if (event.target.id=="remove_payment" && confirm("Подтверждаете удаление?")){


                
              var x = event.target;
              let list = []
             
              
              
              console.log(list[0])

              list.push(x.innerHTML)
              console.log(list[0])

              $.getJSON('/suppliers/remove_payment/'+list[0],{
              id:list[0],
              type: 'POST',
              data:'/suppliers/all_suppliers'
              
              }, function(data){
                  console.log(data)
                  window.location.reload()

              }
              )
            
        
        }else{

            return false;


    }
}

              

            
            
        



            

        
            </script>
            
   

    <script>
    
    $("button#remove_payment").bind('click', function(e){
        let id = $("p#id").html();
        
        console.log(id);
        e.preventDefault();

        

    })

    </script>

   
    <script>
 
            let number = $('#number');
            let amount = $('#s_inv_amount');
            let a = document.getElementById('amount');
       
            number.on('select2:select', function (e) {
            var number = e.params.data;
            myFunction();
            
            var arr = [];
            console.log('arr 1: ' + arr)
           
     
            fetch('/suppliers/s_inv_number/'+ number.text).then(function(response){
                response.json().then(function(data){
                    console.table(data);
                   
     
                    var newDiv = document.createElement("div");
                            newDiv.id = "div1"
     
                    for (let inv of data.invoices){
                       
                        console.log('eto number:' + number.text)
                        arr.push(inv.s_inv_amount)
     
                        
     
     
                        
                        console.log('arr2 :'  + arr)
                        // a.textContent=inv.s_inv_amount; 
                        arr.forEach(function(item){
     
                        var para = document.createElement("p");
                        var node = document.createTextNode(inv.s_inv_amount);
                        para.appendChild(node);
     
     
                        var element = document.getElementById("div1");
                        element.appendChild(para); 
                        console.log('eto elemetn: ' + item) 
                    })
                    
                }
              })
            
            })
     
        
        })
     
            
        
     
        </script>
    
    
    
      
       
<!-- versio1 -->
       
      

            {%endblock%} {%block scripts%} 
            {{super()}}
    {{moment.include_moment()}}
  {{moment.lang('ru')}}
            
            
            {%endblock%}